name: Mobile Smoke Tests

# Runs Maestro flows against the APK produced by build-mobile.yml.
# Trigger manually or chain after a successful APK build.

on:
  workflow_dispatch:
    inputs:
      apk_run_id:
        description: 'build-mobile.yml run ID to download APK from (leave empty to build fresh)'
        required: false

jobs:
  smoke:
    name: Maestro Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── Android emulator ──────────────────────────────────────────────────
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Enable KVM (for hardware acceleration)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' \
            | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Start Android emulator (API 33, x86_64)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          arch: x86_64
          profile: pixel_6
          script: echo "Emulator ready"

      # ── APK ───────────────────────────────────────────────────────────────
      - name: Download APK artifact
        if: ${{ github.event.inputs.apk_run_id != '' }}
        uses: actions/download-artifact@v4
        with:
          name: velum-apk
          run-id: ${{ github.event.inputs.apk_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install APK on emulator
        run: adb install -r velum-v*-arm64.apk

      # ── Maestro ──────────────────────────────────────────────────────────
      - name: Install Maestro CLI
        run: curl -Ls "https://get.maestro.mobile.dev" | bash

      - name: Run smoke tests
        run: ~/.maestro/bin/maestro test velum-mobile/.maestro/
        continue-on-error: false

      - name: Upload Maestro report on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-report
          path: ~/.maestro/tests/
          retention-days: 7
