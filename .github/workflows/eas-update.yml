name: EAS Update (OTA)

# Push JS-only updates instantly — no APK rebuild needed.
# Users get the new version within seconds on next app launch.

on:
  push:
    branches: [main]
    paths:
      - 'velum-mobile/app/**'
      - 'velum-mobile/src/**'
      - 'velum-mobile/assets/**'
      - 'velum-mobile/app.json'
      - 'velum-mobile/package.json'
  workflow_dispatch:
    inputs:
      branch:
        description: 'EAS Update branch (preview or production)'
        required: false
        default: 'production'
      message:
        description: 'Update message'
        required: false
        default: 'OTA update'

permissions:
  contents: read

jobs:
  eas-update:
    name: Push OTA Update
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: velum-mobile

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: velum-mobile/package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Setup EAS CLI
        run: npm install -g eas-cli

      - name: Check for native changes
        id: native-check
        working-directory: .
        run: |
          # If native files changed, skip OTA — a full APK build is needed
          NATIVE_CHANGED=$(git diff --name-only HEAD~1 HEAD -- \
            'velum-mobile/android/**' \
            'velum-mobile/ios/**' \
            'velum-mobile/eas.json' \
            'velum-mobile/babel.config.js' \
            'velum-mobile/metro.config.js' \
            2>/dev/null || echo "")
          if [ -n "$NATIVE_CHANGED" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Native files changed — skipping OTA, needs full APK build:"
            echo "$NATIVE_CHANGED"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "No native changes — safe for OTA update"
          fi

      - name: Push EAS Update
        if: steps.native-check.outputs.skip != 'true'
        run: |
          BRANCH="${{ github.event.inputs.branch || 'production' }}"
          MESSAGE="${{ github.event.inputs.message || format('Update from {0}', github.sha) }}"
          eas update --branch "$BRANCH" --message "$MESSAGE" --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Skip notice
        if: steps.native-check.outputs.skip == 'true'
        run: echo "Skipped OTA update — native files changed. Tag a new version (v*) to trigger a full APK build."
